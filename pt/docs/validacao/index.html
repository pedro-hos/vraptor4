<!DOCTYPE HTML> <html lang="pt"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Validação</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <ul class="community"> <li><a href="https://groups.google.com/forum/#!forum/caelum-vraptor" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://www.guj.com.br/tag/vraptor" target="_blank">GUJ Respostas</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en not-selected" title="en" href="../../../en"> EN </a> </li> <li> <a class="site-language flag flag-pt " title="pt" href="../.."> PT </a> </li> </ul> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../guia-de-1-minuto/">Documentação</a></li> <li><a href="../../cookbook/aceitando-urls-com-ou-sem-barra-no-final">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <nav class="doc-nav container"> <h1>Documentação</h1> <ul> <li><a href="../guia-de-1-minuto">Guia inicial de 1 minuto</a></li> <li><a href="../guia-de-10-minutos">Guia inicial de 10 minutos</a></li> <li><a href="../controllers-rest">Controllers Rest</a></li> <li><a href="../componentes">Componentes</a></li> <li><a href="../conversores">Conversores</a></li> <li><a href=".">Validação</a></li> <li><a href="../interceptadores">Interceptadores</a></li> <li><a href="../eventos">Eventos</a></li> <li><a href="../trabalhando-com-a-view">Trabalhando com a View</a></li> <li><a href="../download-e-upload">Download e Upload</a></li> <li><a href="../environment">Environment</a></li> <li><a href="../plugins">Plugins</a></li> <li><a href="../dependencias-e-pre-requisitos">Dependências e pré requisitos</a></li> <li><a href="../testando-componentes-e-controllers">Testando Componentes e Controllers</a></li> <li><a href="../migrando-de-um-projeto-com-vraptor3">Migrando de um projeto com VRaptor 3</a></li> <li><a href="../contribuindo-com-o-vraptor">Contribuindo com o VRaptor</a></li> </ul> </nav> <main class="container doc-container"> <h1 id="validao">Validação</h1> <p>A validação do VRaptor tira proveito do Bean Validation, especificação presente no Java EE 7 que permite validar nosso modelo baseado em anotações. Com o Bean Validation você pode usar as validações já existentes na especificação ou criar suas próprias anotações.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cliente</span> <span class="o">{</span>
    <span class="c1">// valida se o nome não é nulo e possui tamanho entre 10 e 50</span>
    <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">10</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span> <span class="kd">private</span> <span class="n">String</span> <span class="n">nome</span><span class="o">;</span>

    <span class="c1">// valida se a data de nascimento está no passado</span>
    <span class="nd">@Past</span> <span class="kd">private</span> <span class="n">Date</span> <span class="n">nascimento</span><span class="o">;</span>
<span class="o">}</span></code></pre> <p>Em seu controller:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">cadastrar</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nd">@Valid</span> <span class="n">Cliente</span> <span class="n">cliente</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// em caso de erros irá redirecionar para a página de formulário</span>
    <span class="n">validation</span><span class="o">.</span><span class="na">onErrorForwardTo</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">formulario</span><span class="o">();</span>
<span class="o">}</span></code></pre> <p><strong>Nota</strong>: Se sua aplicação usa Hibernate ou JPA e você tem seu modelo anotado com as anotações do Bean Validation, você precisará chamar os métodos <code>Session.flush()</code> ou <code>EntityManager.flush()</code> para disparar a validação do Bean Validation antes de fazer qualquer <code>redirect</code> ou <code>forward</code>. O método <code>flush()</code> é responsável por sincronizar as alterações no estado dos objetos com o banco de dados. Sendo assim as validações do Bean Validation em entidates só serão executadas no <code>flush()</code>.</p> <h2 id="criando-validaes-customizadas">Criando validações customizadas</h2> <p>Com o Bean Validator você pode criar anotações com suas validações customizadas. Se você quer, por exemplo, validar se o telefone está no formato <code>(00) 0000-0000</code>, você pode criar uma anotação assim:</p> <pre><code class="language-java"><span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@ReportAsSingleViolation</span>
<span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">"\\((\\d{2})\\) (\\d{4})-(\\d{4})"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">PhoneNumber</span> <span class="o">{</span>
    <span class="c1">// você pode colocar uma mensagem fixa, por exemplo, "Telefone inválido" ou</span>
    <span class="c1">// usar uma mensagem de um ResourceBundle, bastando então colocar entre {}</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">"{br.com.vraptor.validations.phonenumber.message}"</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span></code></pre> <p>Você pode também criar validações mais complexas que fazem acesso ao banco de dados, ou algum componente existente. Se você quiser validar se o login de um usuário já está em uso, basta criar o código abaixo:</p> <pre><code class="language-java"><span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">LoginAvailableValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">LoginAvailable</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">"{login_already_exists}"</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span></code></pre> <p>E agora o <code>LoginAvailableValidator</code> que fará a validação:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginAvailableValidator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">LoginAvailable</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span> <span class="kd">private</span> <span class="n">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">userDao</span><span class="o">.</span><span class="na">containsUserWithLogin</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getLogin</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Note no código que é possível injetar qualquer componente gerenciável pelo CDI, que pode ser uma DAO ou qualquer outro componente.</p> <h2 id="redirecionando-em-caso-de-erro">Redirecionando em caso de erro</h2> <p>Quando ocorre um erro de validação, você pode redirecionar o usuário para qualquer outra tela. Abaixo alguns exemplos:</p> <pre><code class="language-java"><span class="n">validator</span><span class="o">.</span><span class="na">onErrorForwardTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">forwardTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorRedirectTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">redirectTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorUsePageOf</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">page</span><span class="o">()).</span><span class="na">of</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorSendBadRequest</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">status</span><span class="o">()).</span><span class="na">badRequest</span><span class="o">(</span><span class="n">errors</span><span class="o">);</span></code></pre> <p>Além disso, se o redirecionamento é para um método do mesmo controller, podemos usar:</p> <pre><code class="language-java"><span class="n">validator</span><span class="o">.</span><span class="na">onErrorForwardTo</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">forwardTo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorRedirectTo</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">redirectTo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorUsePageOf</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">page</span><span class="o">()).</span><span class="na">of</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">list</span><span class="o">();</span></code></pre> <h2 id="mostrando-os-erros-de-validao-no-jsp">Mostrando os erros de validação no JSP</h2> <p>Quando existem erros de validação, o VRaptor coloca um atributo na requisição chamado <code>errors</code> contendo a lista de erros. Essa lista é representada por items chave-valor, onde temos:</p> <ul> <li> <code>category</code>: representa o caminho do atributo que originou o erro, cujo valor é uma convenção para <code>objeto.atributo</code> </li> <li> <code>message</code>: representa a mensagem padrão da API do Bean Validation, normalmente um sufixo como: “deve estar no futuro”, “não pode ser nulo”, etc.</li> </ul> <p>E na view você pode imprimir:</p> <pre><code class="language-xml"><span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">"error"</span> <span class="na">items=</span><span class="s">"${errors}"</span><span class="nt">&gt;</span>
    ${error.category} - ${error.message}<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/c:forEach&gt;</span></code></pre> <p>Você também pode buscar por um erro somente de uma determinada categoria, que é muito útil para quando você quer exibir os erros de validação ao lado de cada campo.</p> <pre><code class="language-xml"><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"cliente.nome"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"error"</span><span class="nt">&gt;</span>${errors.from('cliente.nome')}<span class="nt">&lt;/span&gt;</span> 
// retorna: 'não pode ser nulo, não pode ser menor que 50'

<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"error"</span><span class="nt">&gt;</span>${errors.from('cliente.nome').join(' - ')}<span class="nt">&lt;/span&gt;</span> 
// retorna: 'não pode ser nulo - não pode ser menor que 50'</code></pre> <h2 id="customizando-as-mensagens">Customizando as Mensagens</h2> <p>Se você preferir é possível customizar as mensagens do Bean Validation. Para isso, basta adicionar o arquivo <code>ValidationMessages.properties</code> no seu classpath. Se você usa Maven o local é <code>/src/main/resources</code>.</p> <p>Considerando o exemplo anterior, o arquivo poderia ter a seguinte estrutura para customizar as mensagens padrões:</p> <pre><code class="language-properties"><span class="na">cliente.nome.vazio</span> <span class="o">=</span> <span class="s">O nome do cliente não pode ser vazio</span>
<span class="na">cliente.nome.tamanho</span> <span class="o">=</span> <span class="s">O nome do cliente deve possuir entre {min} e {max} caracteres</span>
<span class="na">cliente.nascimento.data</span> <span class="o">=</span> <span class="s">A data de nascimento ${validatedValue} informada deve ser no passado</span></code></pre> <p>E a classe teria que ser alterada para incluir essas chaves</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cliente</span> <span class="o">{</span>
    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">message</span><span class="o">=</span><span class="s">"{cliente.nome.vazio}"</span><span class="o">)</span> <span class="c1">// o valor entre {} indica que a mensagem vem do ResourceBundle</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">10</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">50</span><span class="o">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"{cliente.nome.tamanho}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nome</span><span class="o">;</span>

    <span class="nd">@Past</span><span class="o">(</span><span class="n">message</span><span class="o">=</span><span class="s">"{cliente.nascimento.data}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">nascimento</span><span class="o">;</span>
<span class="o">}</span></code></pre> <p>Veja que foi adicionado parâmetros afim de deixar nossas mensagens mais dinâmicas e reaproveitáveis. As possibilidades atualmente são:</p> <ul> <li>os valores dos atributos da restrição mapeados com os nomes de atributo. Ex. <code>{min}</code> e <code>{max}</code> no caso de <code>@Size</code> </li> <li>o atual valor a ser validado sob o nome de <code>${validatedValue}</code> </li> <li>uso de if-else curto, como por exemplo: <code>${value &gt; 1 ? 's' : ''}</code> </li> <li>um bean mapeado com o nome de <code>formatter</code> expondo método var-arg <code>format(String format, Object... args)</code> o qual se comporta como <code>java.util.Formatter.format(String format, Object... args)</code>. Ex.: <code>${formatter.format('%1$.2f', validatedValue)}</code> </li> </ul> <h2 id="validao-usando-o-validator">Validação usando o Validator</h2> <p>Caso você não queira usar o Bean Validation, você pode usar os métodos de validação do próprio <code>Validator</code> do VRaptor. O método mais simples é o <code>add</code>:</p> <pre><code class="language-java"><span class="k">if</span> <span class="o">(</span><span class="n">cliente</span><span class="o">.</span><span class="na">getNome</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//mensagem simples</span>
  <span class="n">validator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"nome"</span><span class="o">,</span> <span class="s">"O nome deve ser preenchido"</span><span class="o">));</span>

  <span class="c1">//mensagem internacionalizada</span>
  <span class="n">validator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">I18nMessage</span><span class="o">(</span><span class="s">"nome"</span><span class="o">,</span> <span class="s">"nome.deve.ser.preenchido"</span><span class="o">));</span>
<span class="o">}</span></code></pre> <p>Podemos também usar os métodos <code>addIf</code> que adiciona a mensagem se a condição for verdadeira e o <code>ensure</code> que adiciona se a condição for falsa:</p> <pre><code class="language-java"><span class="n">validator</span><span class="o">.</span><span class="na">addIf</span><span class="o">(</span><span class="n">cliente</span><span class="o">.</span><span class="na">getNome</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"nome"</span><span class="o">,</span> <span class="s">"O nome deve ser preenchido"</span><span class="o">));</span>

<span class="n">validator</span><span class="o">.</span><span class="na">ensure</span><span class="o">(</span><span class="n">cliente</span><span class="o">.</span><span class="na">getNome</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"nome"</span><span class="o">,</span> <span class="s">"O nome deve ser preenchido"</span><span class="o">));</span></code></pre> </main> <script src="/js/headers.min.js"></script> </body> </html>