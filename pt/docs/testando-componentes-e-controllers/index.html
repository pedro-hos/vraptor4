<!DOCTYPE HTML> <html lang="pt"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Testando Componentes e Controllers</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <ul class="community"> <li><a href="https://groups.google.com/forum/#!forum/caelum-vraptor" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://www.guj.com.br/tag/vraptor" target="_blank">GUJ Respostas</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en not-selected" title="en" href="../../../en"> EN </a> </li> <li> <a class="site-language flag flag-pt " title="pt" href="../.."> PT </a> </li> </ul> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../guia-de-1-minuto/">Documentação</a></li> <li><a href="../../cookbook/aceitando-urls-com-ou-sem-barra-no-final">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <nav class="doc-nav container"> <h1>Documentação</h1> <ul> <li><a href="../guia-de-1-minuto">Guia inicial de 1 minuto</a></li> <li><a href="../guia-de-10-minutos">Guia inicial de 10 minutos</a></li> <li><a href="../controllers-rest">Controllers Rest</a></li> <li><a href="../componentes">Componentes</a></li> <li><a href="../conversores">Conversores</a></li> <li><a href="../validacao">Validação</a></li> <li><a href="../interceptadores">Interceptadores</a></li> <li><a href="../eventos">Eventos</a></li> <li><a href="../trabalhando-com-a-view">Trabalhando com a View</a></li> <li><a href="../download-e-upload">Download e Upload</a></li> <li><a href="../environment">Environment</a></li> <li><a href="../plugins">Plugins</a></li> <li><a href="../dependencias-e-pre-requisitos">Dependências e pré requisitos</a></li> <li><a href=".">Testando Componentes e Controllers</a></li> <li><a href="../migrando-de-um-projeto-com-vraptor3">Migrando de um projeto com VRaptor 3</a></li> <li><a href="../contribuindo-com-o-vraptor">Contribuindo com o VRaptor</a></li> </ul> </nav> <main class="container doc-container"> <h1 id="testando-componentes-e-controllers">Testando Componentes e Controllers</h1> <p>Fazer testes de unidade com o VRaptor 4 na maioria das vezes é simples, não fugindo muito dos testes de unidade de uma classe qualquer.</p> <p>Todo o controle de Injeção de Dependência é feito através do CDI e para melhorar a testabilidade de suas classes aconselhamos a injeção de dependências por construtor, dessa forma você pode trabalhar com mocks facilmente, como por exemplo:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PessoaController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Validator</span> <span class="n">validator</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">PessoaController</span><span class="o">(</span><span class="n">Result</span> <span class="n">result</span><span class="o">,</span> <span class="n">Validator</span> <span class="n">validator</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">validator</span> <span class="o">=</span> <span class="n">validator</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @deprecated CDI eyes only</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="nf">PessoaController</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
    
<span class="o">}</span></code></pre> <p>Para testar esse controller, podemos usar o <code>MockResult</code> e <code>MockValidator</code> como dependência:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PessoaControllerTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">MockResult</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">MockValidator</span> <span class="n">validator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">PessoaController</span> <span class="n">controller</span><span class="o">;</span>
    
    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MockResult</span><span class="o">();</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MockValidator</span><span class="o">();</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PessoaController</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">validator</span><span class="o">);</span>
    <span class="o">}</span>
    
<span class="o">}</span></code></pre> <p>O que acontece quando fazemos a injeção de dependência via atributo, é que precisaremos do contexto do CDI e o mesmo não é suportado pelo JUnit, visto que esse cria todo um ambiente para os testes e não levanta esse contexto. No entanto há soluções para que você possa dentro do seu caso de teste subir o contexto CDI e assim usufruir da injeção de dependência, controle transacional e tudo aquilo que você precisa do CDI.</p> <p><code>Result</code> e <code>Validator</code> são componentes quase sempre presentes em seus Controllers, para facilitar seus testes o VRaptor fornece mocks para essas implementações.</p> <h2 id="mockresult">MockResult</h2> <p>O <code>MockResult</code> ignora os redirecionamentos que você fizer, e acumula os objetos incluídos, para você poder inspecioná-los e fazer as suas asserções.</p> <p>Considere o seguinte método da classe <code>PessoaController</code>:</p> <pre><code class="language-java"><span class="nd">@Post</span><span class="o">(</span><span class="s">"/pessoa/adiciona"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Pessoa</span> <span class="n">pessoa</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">validator</span><span class="o">.</span><span class="na">addIf</span><span class="o">(</span><span class="n">pessoa</span><span class="o">.</span><span class="na">getNome</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"nome"</span><span class="o">,</span> <span class="s">"O nome deve ser preenchido"</span><span class="o">));</span>
    <span class="n">validator</span><span class="o">.</span><span class="na">onErrorRedirectTo</span><span class="o">(</span><span class="n">IndexController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">index</span><span class="o">();</span>

    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"success"</span><span class="o">,</span> <span class="s">"Incluído com sucesso."</span><span class="o">);</span>
    
    <span class="n">result</span><span class="o">.</span><span class="na">redirectTo</span><span class="o">(</span><span class="n">IndexController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">index</span><span class="o">();</span>
<span class="o">}</span></code></pre> <p>Para testá-lo você pode em sua classe <code>PessoaControllerTest</code> fazer algo como:</p> <pre><code class="language-java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldHaveSuccessMessage</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Pessoa</span> <span class="n">pessoa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pessoa</span><span class="o">();</span>
    <span class="n">pessoa</span><span class="o">.</span><span class="na">setNome</span><span class="o">(</span><span class="s">"Renan Montenegro"</span><span class="o">);</span>
    
    <span class="n">controller</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pessoa</span><span class="o">);</span>
    
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">included</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"success"</span><span class="o">));</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">"Incluído com sucesso."</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">included</span><span class="o">(</span><span class="s">"success"</span><span class="o">));</span>
<span class="o">}</span></code></pre> <p>Note que qualquer chamada do tipo <code>result.use(...)</code> será ignorada.</p> <h2 id="mockvalidator">MockValidator</h2> <p>O <code>MockValidator</code> vai executar a validação acumulando possíveis erros. Para recuperá-los você pode usar o método <code>getErrors()</code> como você pode ver no exemplo:</p> <pre><code class="language-java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldThrowValidationException</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">controller</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Pessoa</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">fail</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ValidationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrors</span><span class="o">();</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"nome"</span><span class="o">,</span> <span class="s">"O nome deve ser preenchido"</span><span class="o">)));</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">errors</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>A chamada do método <code>validator.onErrorUse</code>, no caso de problema de validação, irá gerar uma <code>ValidationException</code>, que pode ser usado como um resultado esperado pelo seu teste, como a seguir:</p> <pre><code class="language-java"><span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">ValidationException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldThrowValidationException</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">controller</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Pessoa</span><span class="o">());</span>
<span class="o">}</span></code></pre> </main> <script src="/js/headers.min.js"></script> </body> </html>