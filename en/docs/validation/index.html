<!DOCTYPE HTML> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Validation</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <ul class="community"> <li><a href="https://groups.google.com/forum/?hl=en#!forum/vraptor4" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://questions.vraptor.org" target="_blank">VRaptor Questions</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en " title="en" href="../.."> EN </a> </li> <li> <a class="site-language flag flag-pt not-selected" title="pt" href="../../../pt"> PT </a> </li> </ul> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../one-minute-guide/">Documentation</a></li> <li><a href="../../cookbook/accepting-urls-ending-with-a-slash">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <nav class="doc-nav container"> <h1>Documentation</h1> <ul> <li><a href="../one-minute-guide">One minute guide</a></li> <li><a href="../ten-minute-guide">Ten minute guide</a></li> <li><a href="../controllers-rest">REST Controllers</a></li> <li><a href="../components">Components</a></li> <li><a href="../converters">Converters</a></li> <li><a href=".">Validation</a></li> <li><a href="../interceptors">Interceptors</a></li> <li><a href="../events">Events</a></li> <li><a href="../view-and-ajax">View and Ajax</a></li> <li><a href="../download-and-upload">Download and Upload</a></li> <li><a href="../environment">Environment</a></li> <li><a href="../plugins">Plugins</a></li> <li><a href="../dependencies-and-prerequisites">Dependencies and prerequisites</a></li> <li><a href="../testing-components-and-controllers">Testing Components and Controllers</a></li> <li><a href="../migrating-vraptor3-project">Migrating from VRaptor 3</a></li> <li><a href="../contributing-to-vraptor">Contributing to VRaptor</a></li> </ul> </nav> <main class="container doc-container"> <h1 id="validation">Validation</h1> <p>VRaptor validation uses Bean Validation, spec present in Java EE 7, that allow us to validate our beans based on annotations. With this you can use embedded constraints or create your custom constraint.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="c1">// validates if name is not null and size between 10 and 50</span>
    <span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">10</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span> <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="c1">// validates if birth date is past</span>
    <span class="nd">@Past</span> <span class="kd">private</span> <span class="n">Date</span> <span class="n">birth</span><span class="o">;</span>
<span class="o">}</span></code></pre> <p>And in your controller:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">store</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nd">@Valid</span> <span class="n">Client</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// if client is not valid, redirect to form page</span>
    <span class="n">validation</span><span class="o">.</span><span class="na">onErrorForwardTo</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">form</span><span class="o">();</span>
<span class="o">}</span></code></pre> <p><strong>Note</strong>: If your application uses Hibernate or JPA and you have your entities annotated with Bean Validation constraints, you need to call <code>Session.flush()</code> or <code>EntityManager.flush()</code> to validate your model before redirect or forward. The method <code>flush</code> synchronizes state from your objects to database. So Bean Validation constraint will only validate when <code>flush</code> is triggered.</p> <h2 id="creating-your-custom-constraints">Creating your custom constraints</h2> <p>With Bean validation you can create your own custom validations. If you want to validate if phone number is in <code>(00) 0000-0000</code> pattern, you can do something like this:</p> <pre><code class="language-java"><span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@ReportAsSingleViolation</span>
<span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">"\\((\\d{2})\\) (\\d{4})-(\\d{4})"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">PhoneNumber</span> <span class="o">{</span>
    <span class="c1">// you can put a fixed message like "Invalid number" or a message from ResourceBundle with {}</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">"{br.com.vraptor.validations.phonenumber.message}"</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span></code></pre> <p>You can create complex constraints that access database or uses any managed component. If you want, as example, check if the user already exists in the database, ou can write a code like this:</p> <pre><code class="language-java"><span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">LoginAvailableValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">LoginAvailable</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">"{login_already_exists}"</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="n">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span></code></pre> <p>And <code>LoginAvailableValidator</code> that checks the constraint:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginAvailableValidator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">LoginAvailable</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span> <span class="kd">private</span> <span class="n">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">userDao</span><span class="o">.</span><span class="na">containsUserWithLogin</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getLogin</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <h2 id="redirecting-when-a-constraint-error-occurs">Redirecting when a constraint error occurs</h2> <p>When a constraint error occurs, you can redirect or forward the user to another page. Below the possible actions:</p> <pre><code class="language-java"><span class="n">validator</span><span class="o">.</span><span class="na">onErrorForwardTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">forwardTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorRedirectTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">redirectTo</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorUsePageOf</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">page</span><span class="o">()).</span><span class="na">of</span><span class="o">(</span><span class="n">MusicController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorSendBadRequest</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">status</span><span class="o">()).</span><span class="na">badRequest</span><span class="o">(</span><span class="n">errors</span><span class="o">);</span></code></pre> <p>If you want to redirect to the same controller, you can use:</p> <pre><code class="language-java"><span class="n">validator</span><span class="o">.</span><span class="na">onErrorForwardTo</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">forwardTo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorRedirectTo</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">logic</span><span class="o">()).</span><span class="na">redirectTo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">list</span><span class="o">();</span>
<span class="n">validator</span><span class="o">.</span><span class="na">onErrorUsePageOf</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">list</span><span class="o">()</span> <span class="o">==&gt;</span> <span class="n">validator</span><span class="o">.</span><span class="na">onErrorUse</span><span class="o">(</span><span class="n">page</span><span class="o">()).</span><span class="na">of</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">list</span><span class="o">();</span></code></pre> <h2 id="print-the-errors-in-the-view">Print the errors in the view</h2> <p>When an error exists, VRaptor puts an attribute named <code>errors</code> in the request scope, that contains a list with all constraint errors. This list contains a key-value object that represents:</p> <ul> <li> <code>category</code>: represents the full path of the attribute like <code>object.attribute</code> </li> <li> <code>message</code>: represents the error message like: “must be in the future”, “may not be empty”, and so on.</li> </ul> <p>In the view you can do something like this:</p> <pre><code class="language-xml"><span class="nt">&lt;c:forEach</span> <span class="na">var=</span><span class="s">"error"</span> <span class="na">items=</span><span class="s">"${errors}"</span><span class="nt">&gt;</span>
    ${error.category} - ${error.message}<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/c:forEach&gt;</span></code></pre> <p>You can search for an error for a specific category, that can be useful to display constraint the messages beside the field.</p> <pre><code class="language-xml"><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"client.name"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"error"</span><span class="nt">&gt;</span>${errors.from('client.name')}<span class="nt">&lt;/span&gt;</span>
// prints: 'may not be empty, size must be between 10 and 50'

<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"error"</span><span class="nt">&gt;</span>${errors.from('client.name').join(' - ')}<span class="nt">&lt;/span&gt;</span>
// prints: 'may not be empty - size must be between 10 and 50'</code></pre> <h2 id="using-custom-messages">Using custom messages</h2> <p>If you prefer, you can use custom messages with Bean Validation. For this you need to add the file <code>ValidationMessages.properties</code> in your <em>classpath</em>. In a Mavem project, the location is <code>/src/main/resources</code>.</p> <p>Considering the previous example, the file might have the following content to customize the default messages:</p> <pre><code class="language-properties"><span class="na">client.name.empty</span> <span class="o">=</span> <span class="s">The client name may not be empty</span>
<span class="na">client.name.size</span> <span class="o">=</span> <span class="s">The client name size must be between 10 and 50</span>
<span class="na">client.birth.past</span> <span class="o">=</span> <span class="s">The birth must be in the future</span></code></pre> <p>And the class:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cliente</span> <span class="o">{</span>
    <span class="nd">@NotNull</span><span class="o">(</span><span class="n">message</span><span class="o">=</span><span class="s">"{client.name.empty}"</span><span class="o">)</span> <span class="c1">// the value {} indicates that the message comes from the ResourceBundle</span>
    <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">10</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">50</span><span class="o">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"{client.name.size}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@Past</span><span class="o">(</span><span class="n">message</span><span class="o">=</span><span class="s">"{client.birth.past}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">birth</span><span class="o">;</span>
<span class="o">}</span></code></pre> <p>See that was added parameters in order to let our most dynamic and reusable messages. The possibilities are currently:</p> <ul> <li>attribute values ​​of the restriction mapped with the attribute names, like <code>{min}</code> and <code>{max}</code> for <code>@Size</code> </li> <li>the current value to be validated with the name <code>${validatedValue}</code> </li> <li>a ternary operation like: <code>${value &gt; 1 ? 's' : ''}</code> </li> <li>a bean mapped with the name <code>formatter</code> exposing a var-arg method <code>format(String format, Object... args)</code> which behaves like <code>java.util.Formatter.format(String format, Object... args)</code>. Example: <code>${formatter.format('%1$.2f', validatedValue)}</code> </li> </ul> <h2 id="validation-using-validator-class-methods">Validation using Validator class methods</h2> <p>If you don’t want to use Bean Validation, you can use other methods located at <code>Validator</code> class. Below an example with <code>add</code> method:</p> <pre><code class="language-java"><span class="k">if</span> <span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//an hard-coded message</span>
  <span class="n">validator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"The name is mandatory"</span><span class="o">));</span>

  <span class="c1">//i18n message</span>
  <span class="n">validator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">I18nMessage</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"name.mandatory"</span><span class="o">));</span>
<span class="o">}</span></code></pre> <p>You can use another methods like <code>addIf</code>, that only adds the message if a precondition is <code>true</code>, and <code>ensure</code> that only adds the message if the precondition is <code>false</code>:</p> <pre><code class="language-java"><span class="n">validator</span><span class="o">.</span><span class="na">addIf</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"The name is mandatory"</span><span class="o">));</span>

<span class="n">validator</span><span class="o">.</span><span class="na">ensure</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">SimpleMessage</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"The name is mandatory"</span><span class="o">));</span></code></pre> </main> <script src="/js/headers.min.js"></script> </body> </html>