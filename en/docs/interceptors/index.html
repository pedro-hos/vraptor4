<!DOCTYPE HTML> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Interceptors</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <ul class="community"> <li><a href="https://groups.google.com/forum/?hl=en#!forum/vraptor4" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://questions.vraptor.org" target="_blank">VRaptor Questions</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en " title="en" href="../.."> EN </a> </li> <li> <a class="site-language flag flag-pt not-selected" title="pt" href="../../../pt"> PT </a> </li> </ul> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../one-minute-guide/">Documentation</a></li> <li><a href="../../cookbook/accepting-urls-ending-with-a-slash">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <nav class="doc-nav container"> <h1>Documentation</h1> <ul> <li><a href="../one-minute-guide">One minute guide</a></li> <li><a href="../ten-minute-guide">Ten minute guide</a></li> <li><a href="../controllers-rest">REST Controllers</a></li> <li><a href="../components">Components</a></li> <li><a href="../converters">Converters</a></li> <li><a href="../validation">Validation</a></li> <li><a href=".">Interceptors</a></li> <li><a href="../events">Events</a></li> <li><a href="../view-and-ajax">View and Ajax</a></li> <li><a href="../download-and-upload">Download and Upload</a></li> <li><a href="../environment">Environment</a></li> <li><a href="../plugins">Plugins</a></li> <li><a href="../dependencies-and-prerequisites">Dependencies and prerequisites</a></li> <li><a href="../testing-components-and-controllers">Testing Components and Controllers</a></li> <li><a href="../migrating-vraptor3-project">Migrating from VRaptor 3</a></li> <li><a href="../contributing-to-vraptor">Contributing to VRaptor</a></li> </ul> </nav> <main class="container doc-container"> <h1 id="when-intercept">When intercept?</h1> <p>Interceptors are used to perform some task before or after a business logic like data validation, connection control, database transaction, logs and data encryption/compression.</p> <h2 id="how-to-intercept">How to intercept?</h2> <p>VRaptor uses an approach where the interceptor defines who will be intercepted, more closer to the interception approaches used by <strong>AOP</strong> (Aspect Oriented Programming).</p> <p>Therefore, to intercept a request, you need just to annotate the class with the <code>@Intercepts</code>. Like any other component, you can use scoped annotation to define the interceptor life cicle. The default scope for an interceptor is <code>RequestScoped</code>.</p> <h2 id="a-simple-example">A simple example</h2> <p>The class below shows an example how to intercept all requests in a request scoped and simply show the console output that is being invoked. Remember that the interceptor is a component like any other and can receive any dependencies using Dependency Injection.</p> <pre><code class="language-java"><span class="nd">@Intercepts</span>
<span class="nd">@RequestScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">;</span>

    <span class="nd">@AroundCall</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">intercept</span><span class="o">(</span><span class="n">SimpleInterceptorStack</span> <span class="n">stack</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Intercepting "</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">());</span>
        <span class="c1">// code to be executed before the stack</span>

        <span class="n">stack</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// execute the stack</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>To execute the code just before or after the controller execution, we can use annotations <code>@BeforeCall</code> and <code>@AfterCall</code>:</p> <pre><code class="language-java"><span class="nd">@Intercepts</span>
<span class="nd">@RequestScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log</span> <span class="o">{</span>
    <span class="nd">@BeforeCall</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// code executed before</span>
    <span class="o">}</span>

    <span class="nd">@AfterCall</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// code executed after</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <h2 id="defining-when-intercepting">Defining when intercepting</h2> <p>In the example above, all requests are intercepted. But we can define, as example, only methods annotated with <code>@Audit</code> annotation. You just to implement a method that returns a <code>boolean</code> with the necessary condition and annotate it with <code>@Accepts</code>.</p> <pre><code class="language-java"><span class="nd">@Accepts</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accepts</span><span class="o">(</span><span class="n">ControllerMethod</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">containsAnnotation</span><span class="o">(</span><span class="n">Audit</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span></code></pre> <p>Or we can use the more simple way. The example above is a very common case and thus often repeat this code. For this situation we can use the annotation <code>@AcceptsWithAnnotations</code> as described below:</p> <pre><code class="language-java"><span class="nd">@AcceptsWithAnnotations</span><span class="o">(</span><span class="n">Audit</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuditInterceptor</span> <span class="o">{</span>
    
    <span class="nd">@AroundCall</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">around</span><span class="o">(</span><span class="n">SimpleInterceptorStack</span> <span class="n">stack</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stack</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <h2 id="customizing-your-accepts">Customizing your Accepts</h2> <p>In the example above we used a customized accepts with annotation <code>AcceptsWithAnnotations</code>. And if you need, you can create your custom annotation to define when intercepts. Before you need to create your annotation like this example below.</p> <pre><code class="language-java"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@AcceptsConstraint</span><span class="o">(</span><span class="n">WithAnnotationAcceptor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AcceptsWithAnnotations</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Annotation</span><span class="o">&gt;[]</span> <span class="n">value</span><span class="o">();</span>
<span class="o">}</span></code></pre> <p>As you can see, we use the Annotation <code>@AcceptsConstraint</code> to define the class that have our logic. Now we need to implement this class.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WithAnnotationAcceptor</span> <span class="kd">implements</span> <span class="n">AcceptsValidator</span><span class="o">&lt;</span><span class="n">AcceptsWithAnnotations</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">(</span><span class="n">ControllerMethod</span> <span class="n">controllerMethod</span><span class="o">,</span> <span class="n">ControllerInstance</span> <span class="n">instance</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//your code here</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">AcceptsWithAnnotations</span> <span class="n">annotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//your code here</span>
        <span class="k">this</span><span class="o">.</span><span class="na">allowedTypes</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>This class needs only to implements <code>AcceptsValidator&lt;T&gt;</code> interface, where generic <code>T</code> is the type of your custom annotation.</p> <h2 id="how-to-guarantee-the-order-after-and-before">How to guarantee the order: after and before</h2> <p>If you need to guarantee the execution order for your interceptors, you can use the <code>after</code> and <code>before</code> attributes from the <code>@Intercepts</code> annotation. Like the example below, if you have an interceptor named <code>FirstInterceptor</code> that needs to be executed before <code>SecondInterceptor</code>, you can declare like this:</p> <pre><code class="language-java"><span class="nd">@Intercepts</span><span class="o">(</span><span class="n">before</span><span class="o">=</span><span class="n">SecondInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FirstInterceptor</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre> <p>and:</p> <pre><code class="language-java"><span class="nd">@Intercepts</span><span class="o">(</span><span class="n">after</span><span class="o">=</span><span class="n">FirstInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecondInterceptor</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre> <p>You can define one more Interceptor:</p> <pre><code class="language-java"><span class="nd">@Intercepts</span><span class="o">(</span><span class="n">after</span><span class="o">={</span><span class="n">FirstInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">SecondInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
            <span class="n">before</span><span class="o">={</span><span class="n">FourthInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">FifthInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThirdInterceptor</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre> <p>Note: VRaptor throws an exception if there is a cycle in the interceptors order. So be careful when you define interceptors order to avoid cicles.</p> </main> <script src="/js/headers.min.js"></script> </body> </html>